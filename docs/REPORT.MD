# aimbot:一款基于yolov8的自动瞄准程序

## 程序介绍
aimbot是一款基于yolov8的自动瞄准程序，可以实现FPS游戏中的自动瞄准功能。

### 源码说明  
- aimbot.py：主程序，包含了自动瞄准的主要逻辑  
- Capturer.py：封装了用于捕获游戏画面的Capturer类与用于检测的Detector类等  
- apex_v8.pt：训练好的yolov8权重文件  
- logitech.dirver.dll：封装好的罗技鼠标驱动，用于控制鼠标
- logitech.test.py：测试罗技鼠标驱动是否正常工作的脚本

### 参数说明——aimbot.py中的init
- title：游戏窗口的标题
- weights: yolov8权重文件路径
- confidence: 置信度阈值，用于过滤检测结果
- size：目标检测范围, 屏幕中心 size*size 大小
- radius：瞄准生效半径
- ads：鼠标移动倍率，通过调整鼠标实际移动像素和鼠标eDPI的比值来调整自动瞄准的稳定性
- center：屏幕中心坐标
- region：截图范围

### 按键说明
- shift：启动自动瞄准，按住shift不放，准心会自动移动到目标上
- 左方向键：按下左方向键，启动左键瞄准，按住鼠标左键时启动自动瞄准
- 右方向键：按下右方向键，启动右键瞄准，按住鼠标右键时启动自动瞄准
- 上方向键：瞄头，自动瞄准目标从身体切换为头部（精准度不高）
- 下方向键：显示检测结果，按下后会在屏幕上显示检测结果，用于调整参数


### 其他说明
- 游戏分辨率应当与显示器物理分辨率一致
- 游戏的显示模式设置为`无边框窗口`
- 本程序使用《Apex Legend》作为测试游戏，**测试仅使用游戏中的射击场进行测试，并未用于实战，没有任何玩家的游戏体验受到损害**
- 本程序仅供学习交流使用

## 环境要求

**本工程运行环境需求Pytorch + CUDA**

本工程使用Python3.10开发，使用了如下第三方库：
- opencv-python
- numpy
- ultralytics
- pywin32
- pillow
- pynput

## 原理分析

### 键鼠监听
使用第三方库Pynput实现键鼠监听，监听按键后会调用相应的回调函数，实现按键功能


### 鼠标控制
由于大部分FPS屏蔽了操作鼠标的函数，因此无法通过自带的函数直接控制鼠标。为了实现控制鼠标的功能，需要一些特殊的手段。本程序使用的是罗技驱动。代码直接控制罗技驱动向游戏发送鼠标移动指令，从而实现模拟鼠标操作的功能。该方法与鼠标型号无关，任何鼠标均可使用

使用现成的dll文件，搭配指定版本的罗技驱动即可实现鼠标控制功能。

### 获取游戏画面——Capturer类
由于使用PIL库获取游戏画面的速度较慢，因此使用pywin32库直接截取显示器画面，并截取指定区域的画面作为检测范围。具体流程为：
1. 获取屏幕句柄
2. 获取屏幕DC
3. 创建兼容DC
4. 创建bitmap
5. 截图
6. 保存bitmap
7. 释放资源

获取屏幕截图后，将其传入Detector进行检测

### 目标检测——Detector类
Detector类获取从Capturer类获取的游戏画面，使用yolov8进行目标检测并返回检测结果。 具体流程为：
1. 加载模型
2. 模型推理
3. 标注检测结果
4. 获取检测对象的坐标
5. 将截屏坐标系下的坐标xyxy转化为屏幕坐标系下的坐标ltwhxy和截屏坐标系下的ltwhxy
6. 返回检测结果

### 自动瞄准的实现
#### 瞄准对象的选择
本程序的瞄准逻辑为选择距离准心最近的目标：计算准心到各个目标中心点的距离，选择距离最近的目标作为瞄准对象

#### 瞄准算法
首先判断目标是否在瞄准范围内：计算准心到目标中心点的距离，若距离小于给定的阈值，则说明目标在瞄准范围内，继续执行自动瞄准算法

自动瞄准算法：计算准心坐标与目标点坐标的差值(x,y)，将(x,y)*ads作为鼠标移动的距离(ax, ay),调用罗技驱动中的move()完成自动瞄准

#### 检测窗口显示
按下下方向键后，在屏幕中显示检测结果：获取Detector类中的检测结果，再绘制准心与瞄准目标的连线，绘制完成后使用opencv显示检测结果，使用win32gui置顶检测窗口。

### 多进程使用
为目标检测与键鼠监听分别开启一个进程，使用multiprocessing库实现多进程。进程之间使用队列进行通信。


